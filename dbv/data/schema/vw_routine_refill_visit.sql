CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `vw_routine_refill_visit` AS select `p`.`patient_number_ccc` AS `patient_number`,`rst`.`name` AS `type_of_service`,`s`.`Name` AS `client_support`,concat_ws(' ',`p`.`first_name`,`p`.`other_name`,`p`.`last_name`) AS `patient_name`,floor(((to_days(curdate()) - to_days(`p`.`dob`)) / 365)) AS `current_age`,`g`.`name` AS `sex`,concat_ws(' | ',`r`.`regimen_code`,`r`.`regimen_desc`) AS `regimen`,`pv`.`dispensing_date` AS `visit_date`,`pv`.`current_weight` AS `current_weight`,(case when ((`pv`.`pill_count` > 0) and ((`pv`.`missed_pills` - `pv`.`pill_count`) >= `pv`.`pill_count`)) then 0 when ((`pv`.`pill_count` > 0) and ((`pv`.`missed_pills` - `pv`.`pill_count`) > 0)) then round((((`pv`.`missed_pills` - `pv`.`pill_count`) / `pv`.`pill_count`) * 100),2) when ((not((`pv`.`missed_pills` regexp '[0-9]+'))) or isnull(`pv`.`missed_pills`)) then '-' else 100 end) AS `missed_pill_adherence`,(case when ((`pv`.`pill_count` > 0) and ((`pv`.`months_of_stock` - `pv`.`pill_count`) >= `pv`.`pill_count`)) then 0 when ((`pv`.`pill_count` > 0) and ((`pv`.`months_of_stock` - `pv`.`pill_count`) > 0)) then round((((`pv`.`months_of_stock` - `pv`.`pill_count`) / `pv`.`pill_count`) * 100),2) when ((not((`pv`.`months_of_stock` regexp '[0-9]+'))) or isnull(`pv`.`months_of_stock`)) then '-' else 100 end) AS `pill_count_adherence`,(case when (replace(`pv`.`adherence`,'%','') > 100) then 100 when (replace(`pv`.`adherence`,'%','') < 0) then 0 when (replace(`pv`.`adherence`,'%','') = 'Infinity') then '' else replace(`pv`.`adherence`,'%','') end) AS `appointment_adherence`,`ps`.`name` AS `source` from (((((((`patient_visit` `pv` left join `patient` `p` on((`p`.`patient_number_ccc` = `pv`.`patient_id`))) left join `regimen_service_type` `rst` on((`rst`.`id` = `p`.`service`))) left join `supporter` `s` on((`s`.`id` = `p`.`supported_by`))) left join `gender` `g` on((`g`.`id` = `p`.`gender`))) left join `regimen` `r` on((`r`.`id` = `pv`.`regimen`))) left join `patient_source` `ps` on((`ps`.`id` = `p`.`source`))) left join `visit_purpose` `v` on((`v`.`id` = `pv`.`visit_purpose`))) where ((`pv`.`active` = 1) and (`v`.`name` like '%routine%'))